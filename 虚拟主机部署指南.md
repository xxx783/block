# 虚拟主机部署指南

本指南提供了在虚拟主机环境中部署免费观影网站应用的详细步骤和配置建议。

## 一、环境准备

### 1. 检查Python版本
确保虚拟主机上安装了Python 3.6或更高版本：
```bash
python --version
```

### 2. 创建虚拟环境（推荐）
在虚拟主机上为应用创建独立的Python虚拟环境：
```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Linux/Mac
source venv/bin/activate
# Windows
venv\Scripts\activate
```

## 二、部署配置调整

### 1. 修改app.py中的启动配置
需要对app.py文件进行以下修改以适应虚拟主机环境：

```python
# 修改前
if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0')

# 修改后
if __name__ == '__main__':
    app.run(debug=False, host='0.0.0.0', port=5000)
```

### 2. 配置环境变量
为了安全起见，应将敏感配置移至环境变量：

```python
# 修改app.py中的配置部分
import os

app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'your-default-secret-key')

# 邮件配置
app.config['MAIL_USERNAME'] = os.environ.get('MAIL_USERNAME', 'default@example.com')
app.config['MAIL_PASSWORD'] = os.environ.get('MAIL_PASSWORD', 'default-password')
```

### 3. 安装WSGI服务器
在生产环境中，不应使用Flask自带的开发服务器。推荐安装Gunicorn：

```bash
pip install gunicorn
```

## 三、依赖安装

使用requirements.txt安装项目依赖：

```bash
pip install -r requirements.txt
```

## 四、数据库配置

### 1. 确保instance目录存在
应用使用instance目录存储SQLite数据库，确保该目录存在且有正确的权限：

```bash
mkdir -p instance
chmod 755 instance
```

### 2. 初始化数据库
如果是首次部署，需要初始化数据库：

```bash
# 确保数据库文件存在
if [ ! -f instance/app.db ]; then
    touch instance/app.db
    chmod 644 instance/app.db
fi

# 如果有初始化脚本，可以运行
# python init_db.py
```

## 五、启动应用

### 1. 使用Gunicorn启动（推荐）

```bash
gunicorn --bind 0.0.0.0:5000 app:app
```

### 2. 配置进程数和线程数
根据虚拟主机的CPU和内存资源，可以调整Gunicorn的进程数和线程数：

```bash
gunicorn --bind 0.0.0.0:5000 --workers 2 --threads 4 app:app
```

### 3. 使用nohup使应用在后台运行

```bash
nohup gunicorn --bind 0.0.0.0:5000 app:app > app.log 2>&1 &
```

## 六、虚拟主机特定配置

### 1. 端口映射
大多数虚拟主机提供商允许您映射特定端口到域名。需要将虚拟主机的外部端口映射到应用运行的端口（默认为5000）。

### 2. 文件权限
确保所有文件都有正确的权限设置，特别是静态文件和数据库文件：

```bash
chmod -R 755 static/
templates/
chmod 644 app.py
```

### 3. 防火墙设置
确保虚拟主机的防火墙允许访问应用运行的端口。

## 七、监控与日志

### 1. 查看应用日志

```bash
tail -f app.log
```

### 2. 配置日志级别
可以在app.py中调整日志级别以获取更详细的信息：

```python
import logging
logging.basicConfig(level=logging.INFO)
```

## 八、常见问题与解决方案

### 1. 数据库权限问题
如果遇到数据库文件无法访问的错误，请检查instance目录和数据库文件的权限设置。

### 2. 邮件发送失败
确保邮件服务器配置正确，特别是SMTP服务器地址、端口、用户名和密码（授权码）。

### 3. 端口冲突
如果5000端口已被占用，可以修改app.py中的端口配置：

```python
app.run(debug=False, host='0.0.0.0', port=8080)
```

### 4. 静态文件无法加载
确保templates和static目录位于正确的位置，并且应用有权限访问这些目录。

## 九、更新应用

当需要更新应用时，按照以下步骤操作：

1. 停止正在运行的应用
2. 备份数据库文件
3. 上传新的代码文件
4. 更新依赖（如有必要）
5. 重启应用

---

请根据您的虚拟主机具体环境调整上述配置和命令。如有任何问题，请参考虚拟主机提供商的文档或联系他们的技术支持。